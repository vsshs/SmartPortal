@model IEnumerable<SmartPortal.Web.ViewModels.PatientViewModel>

@{
    ViewBag.Title = "Patients";
}

<style>
    .with-color {
        color: whitesmoke !important;
    }

    .panel-body {
        padding: 5px 10px;
    }

    .panel-heading {
        padding: 5px 15px;
        white-space: nowrap;
        overflow: hidden;
    }

    .well-heading {
        background-color: #f5f5f5;
        border: 1px solid #e3e3e3;
        border-radius: 3px;
        max-width: 100px;
        margin-bottom: 5px;
    }

    .well-moveup {
        margin-top: -7px;
    }

    .well-sm {
        margin-bottom: 1px;
        overflow: hidden;
    }

    .button-patient {
        width: 72px;
        margin-top: 5px;
    }

    p {
        margin: 0;
        white-space: nowrap;
    }

    .patient-data {
        font-size: .9em;
    }

    .modal-dialog {
        width: 90%;
    }
    #patients-view {
        display: none;
    }
</style>



<div id="loading"><img src="/Content/ajax-loader.gif" alt="Loading..." /></div>

<div class="row" id="patients-view" data-bind="foreach: items">
    <div class="col-xs-12 col-sm-6 col-md-3">
        <div class="panel panel-default">
            <div class="panel-heading" data-bind="text: Name">
            </div>
            <div class="panel-body">
                <!-- General info -->
                <p>Room: <span data-bind="text: Location"></span></p>
                <!-- Record data -->
                <div class="well-heading with-color" data-bind="style: { backgroundColor: Color }"><b>&nbsp;Record:</b></div>
                <div class="well well-sm well-moveup with-color" data-bind="style: { backgroundColor: Color }">
                    <p><i>Loc: </i><span class="patient-data" data-bind="text: RecordLocation"></span></p>
                    <p><i>Proc: </i><span class="patient-data" data-bind="text: Procedure"></span></p>
                    <p><i>Msg: </i><span class="patient-data" data-bind="text: LastMessage"></span></p>
                </div>
                <!-- Controls -->
                <a class="btn btn-default button-buzzer button-patient" href="#" title="Buzz the buzzer" data-bind="attr: { 'data-patient-id': Id }">Buzz <span class="glyphicon glyphicon-volume-up" data-bind="style: {display: Buzz}"></span></a>
                <a class="btn btn-default button-open button-patient" title="Open the record" data-bind="attr: { 'data-patient-id': Id }">Open</a>

            </div>

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal " id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body" id="load-edit-content-here">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm btn-modal-close" data-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="~/Scripts/Patient.js"></script>
    <script src="~/Scripts/jquery.signalR-2.0.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script>
        
        $(function () {
            var editContentUrl = '@Url.Action("Edit", "Patients")';
            var messagesUrl = '@Url.Action("AddMessage", "Patients")';
            var otherDataUrl = '@Url.Action("OtherPatientData", "Patients")';
            var nurseId = '@Session["NurseId"]';
            var myTabletId = '@ViewBag.TabletId'; // rfid value of the tag
            
            var items = vm.items; // patient items for knocout
            
            
            /* 
                OTHER STUFF
            */
            $("body").on("click", ".btn-modal-close", function () {
                //$('body').off('click', ".button-color-select", function () {
                $("#load-edit-content-here").html("<img src='/Content/ajax-loader.gif' alt='Loading...'/>");
                //});

            });

            $("body").on("click", ".button-open", function (event) {
                event.preventDefault();
                if (nurseId.length == 0) {
                    toastr.error("Nobody is logged into the system!");
                    return true;
                }

                console.log("should open ");
                $('#myModal').modal({
                    keyboard: false
                });
                var patientId = $(this).attr("data-patient-id");
                $("#load-edit-content-here")
                    .load(editContentUrl + "?patientId=" + patientId, function () {
                        $("#patient-data-other")
                            .hide()
                            .load(otherDataUrl + "?patientId=" + patientId)
                            .fadeIn();
                        $("#patient-data-messages")
                            .hide()
                            .load(messagesUrl + "?patientId=" + patientId)
                            .fadeIn();
                    });

                return true;

            });

            var canBeClicked = true;
            $('body').on('click', ".button-color-select", function () {
                if (!canBeClicked)
                    return true; // avpid double click
                $(".button-color-select").prop('disabled', true);
                //event.preventDefault();
                canBeClicked = false;

                console.log("--- button-color-select CLICK");

                var r = $(this).attr("data-r");
                var g = $(this).attr("data-g");
                var b = $(this).attr("data-b");
                var patientId = $(this).attr("data-patient-id");

                console.log(r, ' ', g, ' ', b, ' ', patientId);

                var url = '/api/patient/UpdateColor';
                // 
                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        patientId: patientId,
                        r: r,
                        g: g,
                        b: b,
                        nurseId: nurseId
                    },
                    success: function (result) {
                        console.log("success");
                        $("#other-patient-data-color").css("background-color", "rgb(" + r + "," + g + "," + b + ")");
                        console.log(result);
                        $(".button-color-select").prop('disabled', false);
                        canBeClicked = true;
                        toastr.success("Color has been changed");

                    },
                    fail: function () {
                        console.log("fail");
                        $(".button-color-select").prop('disabled', false);
                        canBeClicked = true;
                        toastr.fail("Error saving data!");
                    }


                });
                return true;

            });

            $('body').on('click', ".button-buzzer", function (event) {
                var self = $(this);
                self.attr('disabled', true);
                event.preventDefault();
                
                var url = '/api/patient/UpdateBuzzer';
                var id = self.attr("data-patient-id");
                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        patientId: id
                    },
                    success: function (result) {
                        console.log(result);
                        self.attr('disabled', false);
                    }
                });
                return true;
            });

            /*
                HUB STUFF
            */
            
            // declaration
            var patientsHub = $.connection.patientsManagerHub;

            // methods
            patientsHub.client.addPatient = function (patient) {
                toastr.info("Patient added: " + patient.name);
                items.push(new ItemViewModel(
                        patient.id,
                        patient.name,
                        patient.cpr,
                        patient.location,
                        patient.recordLoacation,
                        patient.procedure,
                        patient.color,
                        patient.lastMessage));

            };

            patientsHub.client.updatePatient = function (patient) {
                toastr.info("Patient updated: " + patient.name);
                console.log(patient);
                var itemToUpdate = new ItemViewModel(
                    patient.id,
                    patient.name,
                    patient.cpr,
                    patient.location,
                    patient.recordLoacation,
                    patient.procedure,
                    patient.color,
                    patient.lastMessage,
                    patient.buzz);

                var itemFound;
                var match = ko.utils.arrayFirst(vm.items(), function (item) {
                    //console.log(item);
                    var found = itemToUpdate.Id() === item.Id();
                    console.log("found = " + found);
                    if (found)
                        itemFound = item;
                    return found;
                });
                
                if (!match) {
                    console.log("not match. adding");
                    items.push(itemToUpdate);
                } else {
                    itemFound.Name(itemToUpdate.Name());
                    itemFound.Cpr(itemToUpdate.Cpr());
                    itemFound.Location(itemToUpdate.Location());
                    itemFound.RecordLocation(itemToUpdate.RecordLocation());
                    itemFound.Procedure(itemToUpdate.Procedure());
                    itemFound.Color(itemToUpdate.Color());
                    itemFound.LastMessage(itemToUpdate.LastMessage());
                    itemFound.Buzz(itemToUpdate.Buzz());

                }
                
            };

            patientsHub.client.showPatient = function (pId, tabletId) {
                toastr.info("Showing patient id=" + pId + " on " + tabletId);
            };

            // init
            $.connection.hub
                .start()
                .done(function () {
                    //console.log("Connected");
                    toastr.info("Hub connected using " + $.connection.hub.transport.name);

                    $.ajax({
                        url: '/api/patient/getpatients',
                        type: 'GET',
                        accept: 'application/json',
                        success: function (result) {
                            console.log("Received");
                            console.log(result);
                            $("#patients-view").fadeIn();
                            $('#loading').remove();
                           
                            $.each(result, function (index, value) {
                                items.push(new ItemViewModel(value.id, value.name, value.cpr, value.location, value.recordLoacation, value.procedure, value.color, value.lastMessage, value.buzz));
                            });

                        }
                    });
                })
                .fail(function () {
                    toastr.error("Hub could not be reached!");
                    $('#loading').text("Error: Hub could not be reached");
                });


            /*
                Helper functions            
            */

            function htmlEncode(value) {
                var encodedValue = $('<div />').text(value).html();
                return encodedValue;
            }
        });
    </script>
}

