@{
    ViewBag.Title = "Patients";
}
<style type="text/css">
    .col-content {
        padding: 10px;
    }

    dialog {
        border: 1px solid rgba(0, 0, 0, 0.3);
        border-radius: 6px;
        box-shadow: 0 3px 7px rgba(0, 0, 0, 0.3);
    }

        dialog::backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
        }

    #dialog-form-single, #dialog-form-color {
        display: none;
    }

    .button-patient {
        margin-top: 5px;
    }

    .button-color-select {
        margin-top: 5px;
        width: 100%;
    }
</style>
<div style="height: 50px"></div>
<h1>Patients</h1>

<p>Nurse ID: @ViewBag.NurseId</p>
<p>Tablet ID: @ViewBag.TabletId</p>

<div id="loading">Loading. Please wait... </div>

<div class="row" id="patients-row">
</div>


<div id="dialog-form-single" title="__">
    <form>
        <input id="patientId" type="hidden" name="patientId" value="" />
        <div class="input-group">
            <span class="input-group-addon">Val</span>
            <input id="editValue" type="text" class="form-control" placeholder="New Value" name="editValue" />
        </div>

        <div class="input-group">
            <span class="input-group-addon">Pin</span>
            <input id="pin" type="password" class="form-control" placeholder="Pin" name="pin" />
        </div>
    </form>
</div>

<div id="dialog-form-color" title="Change color">
    <a class="btn btn-success button-color-select" href="#" title="Change patient's color" style="background-color: rgb(255, 255, 255)" data-r="255" data-g="255" data-b="255">Choose</a>
    <a class="btn btn-success button-color-select" href="#" title="Change patient's color" style="background-color: rgb(255, 255, 0)" data-r="255" data-g="255" data-b="0">Choose</a>
    <a class="btn btn-success button-color-select" href="#" title="Change patient's color" style="background-color: rgb(255, 0, 0)" data-r="255" data-g="0" data-b="0">Choose</a>
    <a class="btn btn-success button-color-select" href="#" title="Change patient's color" style="background-color: rgb(0, 0, 0)" data-r="0" data-g="0" data-b="0">Choose</a>
    <a class="btn btn-success button-color-select" href="#" title="Change patient's color" style="background-color: rgb(0, 0, 255)" data-r="0" data-g="0" data-b="255">Choose</a>
    <a class="btn btn-success button-color-select" href="#" title="Change patient's color" style="background-color: rgb(0, 255, 255)" data-r="0" data-g="255" data-b="255">Choose</a>
    <a class="btn btn-success button-color-select" href="#" title="Change patient's color" style="background-color: rgb(0, 255, 0)" data-r="0" data-g="255" data-b="0">Choose</a>



</div>


@section scripts
{
    <script src="~/Scripts/jquery.signalR-2.0.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script type="text/javascript">
        $(function () {

            var baseUrl = "@Url.Content("~")";

            var myTabletId = '@ViewBag.TabletId';
            var patientId = $("#patientId");
            var editValue = $("#editValue");
            var pin = $("#pin");

            $("#dialog-form-single").dialog({
                autoOpen: false,
                height: 300,
                width: 350,
                modal: true,

                close: function () {
                    clearForm();
                    //allFields.val( "" ).removeClass( "ui-state-error" );
                }
            });

            function clearForm() {
                patientId.val('');
                editValue.val('');
                pin.val('');
            }

            $("#dialog-form-color").dialog({
                autoOpen: false,
                height: 400,
                width: 300,
                modal: true,
                buttons: {
                    Cancel: function () {
                        colorActivePatientId = -1;
                        $("#dialog-form-color").dialog("close");
                    }
                },
                close: function () {
                    colorActivePatientId = -1;
                    //allFields.val( "" ).removeClass( "ui-state-error" );
                }
            });


            var saveButtonFunctionality_procedure = function () {
                var url = baseUrl + 'api/patient/UpdateProcedure';


                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        patientId: patientId.val(),
                        procedure: editValue.val(),
                        pin: pin.val()
                    },
                    success: function (result) {
                        console.log(result);
                        clearForm();
                        $("#dialog-form-single").dialog("close");

                    }
                });
            };

            var saveButtonFunctionality_room = function () {
                var url = baseUrl + 'smartportal/api/patient/UpdateRoom';


                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        patientId: patientId.val(),
                        room: editValue.val(),
                        pin: pin.val()
                    },
                    success: function (result) {
                        console.log(result);
                        clearForm();
                        $("#dialog-form-single").dialog("close");

                    }
                });
            };

            var saveButtonFunctionality_color = function (r, g, b) {
                var url = baseUrl + 'api/patient/UpdateColor';
                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        patientId: colorActivePatientId,
                        r: r,
                        g: g,
                        b: b,
                        pin: pin.val()
                    },
                    success: function (result) {
                        console.log(result);
                        colorActivePatientId = -1;
                        $("#dialog-form-color").dialog("close");

                    }
                });
            };


            $('body').on('click', ".button-procedure", function (event) {
                event.preventDefault();
                $("#patientId").val($(this).attr("data-patient-id"));
                $("#dialog-form-single").dialog('option', 'title', 'Update procedure');
                $("#dialog-form-single").dialog('option', 'buttons', {
                    "Save": saveButtonFunctionality_procedure,
                    Cancel: function () {
                        clearForm();
                        $(this).dialog("close");
                    }
                });

                $("#dialog-form-single").dialog("open");
            });

            $('body').on('click', ".button-color", function (event) {
                event.preventDefault();
                colorActivePatientId = $(this).attr("data-patient-id");
                $("#dialog-form-color").dialog("open");
            });

            $('body').on('click', ".button-room", function (event) {
                event.preventDefault();
                $("#patientId").val($(this).attr("data-patient-id"));
                $("#dialog-form-single").dialog('option', 'title', 'Update Room');
                $("#dialog-form-single").dialog('option', 'buttons', {
                    "Save": saveButtonFunctionality_room,
                    Cancel: function () {
                        clearForm();
                        $(this).dialog("close");
                    }
                });

                $("#dialog-form-single").dialog("open");
            });


            $('body').on('click', ".button-buzzer", function (event) {
                event.preventDefault();
                var url = baseUrl + 'api/patient/UpdateBuzzer';
                var id = $(this).attr("data-patient-id");
                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        patientId: id
                    },
                    success: function (result) {
                        console.log(result);

                    }
                });
            });
            $('body').on('click', ".button-color-select", function (event) {
                event.preventDefault();

                var r = $(this).attr("data-R");
                var g = $(this).attr("data-G");
                var b = $(this).attr("data-B");
                saveButtonFunctionality_color(r, g, b);

            });

            var colorActivePatientId = -1;

            /*
                HUB stuff
            */
            // models

            function patientToHtml(patient) {
                var patientObject =
                    '<div class="col-xs-12 col-sm-6 col-md-3" id="patient-__patient.Id">' +
                        '    <div class="panel panel-default">' +
                        '        <div id="patient-__patient.Id-name" class="panel-heading">__patient.Name</div>' +
                        '        <div class="panel-body">' +
                        '            <p id="patient-__patient.Id-cpr">CPR: __patient.Cpr</p>' +
                        '            <p id="patient-__patient.Id-location">Room: __patient.Location</p>' +
                        '            <p id="patient-__patient.Id-procedure">Proc: __patient.Procedure</p>' +
                        '            <div class="panel panel-default">' +
                        '                <div id= "patient-__patient.Id-record-color-title" class="panel-heading" style="background-color: __patient.Color; color: rgb(255, 255, 255)">Record</div>' +
                        '                <div class="panel-body">' +
                        '                    <p id="patient-__patient.Id-record-location">Location: Room __patient.RecordLoaction</p>' +
                        '                    <p>Color: <span id="patient-__patient.Id-record-color" style="background-color: __patient.Color; color: __patient.Color">....</span></p>' +
                        '                </div>' +
                        '            </div>' +
                        '            <a class="btn btn-success button-checkin button-patient" data-patient-id="__patient.Id" href="#" title="Checkin">Check in</a>' +
                        '            <a class="btn btn-success button-procedure button-patient" data-patient-id="__patient.Id" href="#" title="Change patient\'s procedure">Procedure</a>' +
                        '            <a class="btn btn-success button-room button-patient" data-patient-id="__patient.Id" href="#" title="Change patient\'s room">Room</a>' +
                        '            <a class="btn btn-success button-color button-patient" data-patient-id="__patient.Id" href="#" title="Change patient\'s Color">Color</a>' +
                        '            <a class="btn btn-success button-buzzer button-patient" data-patient-id="__patient.Id" href="#" title="Buzz the buzzer">Buzz</a>' +
                        '        </div>' +
                        '    </div>' +
                        '</div>';

                patientModel = patient;
                return patientObject
                    .replace(new RegExp('__patient.Id', "g"), patientModel.id)
                    .replace(new RegExp("__patient.Name", "g"), patientModel.name)
                    .replace(new RegExp("__patient.Cpr", "g"), patientModel.cpr)
                    .replace(new RegExp("__patient.Location", "g"), patientModel.location)
                    .replace(new RegExp("__patient.Procedure", "g"), patientModel.procedure)
                    .replace(new RegExp("__patient.RecordLoaction", "g"), patientModel.recordLocation)
                    .replace(new RegExp("__patient.Color", "g"), patientModel.color);


            }

            var patientModel = {
                id: "",
                name: "",
                cpr: "",
                location: "",
                recordLocation: "",
                procedure: "",
                color: "",
                lastMessage:""
            };

            // declaration
            var patientsHub = $.connection.patientsManagerHub;

            // methods
            patientsHub.client.addPatient = function (patient) {
                var exists = $("#patient-" + patient.id).length > 0;
                if (!exists) {
                    toastr.info("Added a patient: " + patient.name);
                    $("#patients-row").prepend(patientToHtml(patient));
                }
            };

            patientsHub.client.updatePatientsRecordLocation = function (patientId, location) {

                console.log(patientId + " LOCATION:  " + location);
            };


            patientsHub.client.updatePatient = function (patient) {

                toastr.info("Patient got UPDATED: " + patient.name);

                var str = patientToHtml(patient);
                var obj = $('<div/>').html(str);


                $("#patient-" + patient.id).html(obj.find("#patient-" + patient.id).html());

            };


            patientsHub.client.showPatient = function (patient, tabletId) {
                if (myTabletId.length > 0) {
                    if (myTabletId == tabletId) {
                        console.log("Should show patient with id: " + patient);
                        toastr.info("Should show patient with id: " + patient);
                    }
                }
            };

            // init
            $.connection.hub
                .start()
                .done(function () {
                    //console.log("Connected");
                    toastr.info("Hub connected");

                    $.ajax({
                        url: 'api/patient/getpatients',
                        type: 'GET',
                        accept: 'application/json',
                        success: function (result) {
                            console.log("Receuved");
                            console.log(result);
                            $('#loading').remove();
                            $.each(result, function (i, item) {
                                $("#patients-row").prepend(patientToHtml(item));
                            });


                        }
                    });
                })
                .fail(function () {
                    toastr.error("Hub could not be reached!");
                    $('#loading').text("Error: Hub could not be reached");
                });


            /*
                Helper functions            
            */

            function htmlEncode(value) {
                var encodedValue = $('<div />').text(value).html();
                return encodedValue;
            }
        });
    </script>
}
